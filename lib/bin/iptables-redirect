#!/bin/bash

set -eu
usage() (
    echo "Usage: $0 on|off" >&2
    exit 2
)
if [ $# != 1 ] ; then usage; fi

if [ "$1" = "on" ] ; then
    I=I
elif [ "$1" = "off" ] ; then
    I=D
else
    usage
fi



if [ -v SCREEN ] ; then
    P=$(( 5900 + $SCREEN ))

    for I in $(ls /sys/class/net) ; do
        if [ "$I" = "lo" ] ; then continue ; fi
        iptables -t nat -$I PREROUTING -i $I -p tcp --dport $P -j DNAT --to-destination 127.0.0.1:$P
    done
fi

if [ -v MQTT ] ; then
    iptables -t nat -$I OUTPUT -o lo -p tcp -m owner --uid-owner $UID -m tcp --dport 1883 -j DNAT --to-destination 127.0.0.1:$MQTT
fi

if [ -v MQTTWS ] ; then
    iptables -t nat -$I OUTPUT -o lo -p tcp -m owner --uid-owner $UID -m tcp --dport 9001 -j DNAT --to-destination 127.0.0.1:$MQTTWS
fi
