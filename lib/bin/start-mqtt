#!/bin/bash

# Place your local configuration in /etc/mosquitto/conf.d/
#
# A full description of the configuration file is at
# /usr/share/doc/mosquitto/examples/mosquitto.conf.example

test -v UID || UID=$(id -u)
test -v USER || UID=$(id -un)
LIB=/var/lib/venusian/$USER/mosquitto
RUN=/run/user/$UID
PORT=$(expr 41000 + $UID)
RETAIN=true
if test -f /etc/venusian/env ; then
	. /etc/venusian/env
fi

mkdir -p $LIB $RUN

sed \
	-e "s#@UID@#$UID#g"   \
	-e "s#@USER@#$USER#g" \
	-e "s#@HOST@#$(hostname -s)#g" \
	-e "s#@LIB@#$LIB#g" \
	-e "s#@PORT@#$PORT#g" \
	-e "s#@RETAIN@#$RETAIN#g" \
	> $RUN/mosquitto.conf <<'_END_'
# autogenerated by /usr/lib/venusian/bin/start-mqtt

pid_file /run/user/@UID@/mosquitto.pid

retain_available @RETAIN@
persistence @RETAIN@
persistence_location @LIB@

log_dest none
log_dest syslog
# log_dest topic
log_timestamp false

set_tcp_nodelay true
sys_interval 30

listener @PORT@ 0.0.0.0
allow_anonymous true  ## TODO

connection upstream
remote_clientid @HOST@-v-@USER@
address 127.0.0.1:40990
topic # both "" V/@HOST@/@USER@/

notifications @RETAIN@
notification_topic "V/@HOST@/@USER@/ON" 
restart_timeout 5 60
_END_

exec /usr/sbin/mosquitto -c $RUN/mosquitto.conf
